#!/usr/bin/env node
"use strict";
var $__getDescriptors = function(object) {
  var descriptors = {}, name, names = Object.getOwnPropertyNames(object);
  for (var i = 0; i < names.length; i++) {
    var name = names[i];
    descriptors[name] = Object.getOwnPropertyDescriptor(object, name);
  }
  return descriptors;
}, $__createClassNoExtends = function(object, staticObject) {
  var ctor = object.constructor;
  Object.defineProperty(object, 'constructor', {enumerable: false});
  ctor.prototype = object;
  Object.defineProperties(ctor, $__getDescriptors(staticObject));
  return ctor;
};
var optimist = require("optimist");
var fs = require("fs");
var path = require("path");
var through = require("through");
function extend(target) {
  for (var sources = [], $__1 = 1; $__1 < arguments.length; $__1++) sources[$__1 - 1] = arguments[$__1];
  var toString = {}.toString;
  sources.forEach(function(source) {
    for (var key in source) {
      target[key] = source[key];
    }
  });
  return target;
}
var CLI = function() {
  'use strict';
  var $CLI = ($__createClassNoExtends)({
    constructor: function(Compiler) {
      var stdin = arguments[1] !== (void 0) ? arguments[1]: process.stdin;
      var stdout = arguments[2] !== (void 0) ? arguments[2]: process.stdout;
      var fs_ = arguments[3] !== (void 0) ? arguments[3]: fs;
      this.Compiler = Compiler;
      this.stdin = stdin;
      this.stdout = stdout;
      this.fs = fs_;
    },
    start: function(argv) {
      var options = this.parseArgs(argv);
      if (options.help) {
        this.argParser(argv).showHelp();
      } else if (options.stdio) {
        this.processStdio(options);
      } else {
        for (var i = 2; i < options._.length; i++) {
          var filename = options._[i];
          this.processPath(filename, options);
        }
      }
    },
    parseArgs: function(argv) {
      var args = this.argParser(argv).argv;
      if (args.imports) {
        var imports = {};
        args.imports.split(',').forEach(function(pair) {
          var $__2 = pair.split(':'), requirePath = $__2[0], global = $__2[1];
          imports[requirePath] = global;
        });
        args.imports = imports;
      }
      if (args.global) {
        args.into = args.global;
      }
      return args;
    },
    argParser: function(argv) {
      return optimist(argv).usage('compile-modules usage:\n\n  Using files:\n    compile-modules INPUT --to DIR [--infer-name] [--type TYPE] [--imports PATH:GLOBAL]\n\n  Using stdio:\n    compile-modules --stdio [--type TYPE] [--imports PATH:GLOBAL] [--module-name MOD]').options({
        type: {
          "default": 'amd',
          describe: 'The type of output (one of "amd", "yui", "cjs", or "globals")'
        },
        to: {describe: 'A directory in which to write the resulting files'},
        imports: {describe: 'A list of path:global pairs, comma separated (e.g. jquery:$,ember:Ember)'},
        'infer-name': {
          "default": false,
          type: 'boolean',
          describe: 'Automatically generate names for AMD and YUI modules'
        },
        'module-name': {
          describe: 'The name of the outputted module',
          alias: 'm'
        },
        stdio: {
          "default": false,
          type: 'boolean',
          alias: 's',
          describe: 'Use stdin and stdout to process a file'
        },
        global: {describe: 'When the type is `globals`, the name of the global to export into'},
        help: {
          "default": false,
          type: 'boolean',
          alias: 'h',
          describe: 'Shows this help message'
        }
      }).check((function($__2) {
        var type = $__2.type;
        return type === 'amd' || type === 'yui' || type === 'cjs' || type === 'globals';
      })).check((function(args) {
        return !args['infer-name'] || !args.m;
      })).check((function(args) {
        return (args.stdio && args.type === 'amd') ? !args['infer-name']: true;
      })).check((function(args) {
        return (args.stdio && args.type === 'yui') ? !args['infer-name']: true;
      })).check((function(args) {
        return args.stdio || args.to || args.help;
      })).check((function(args) {
        return args.imports ? args.type === 'globals': args.type !== 'globals';
      }));
    },
    processStdio: function(options) {
      this.processIO(this.stdin, this.stdout, options);
    },
    processIO: function(input, output, options) {
      try {
        throw undefined;
      } catch (end) {
        try {
          throw undefined;
        } catch (write) {
          var data = '', self = this;
          write = function(chunk) {
            data += chunk;
          };
          end = function() {
            this.queue(self._compile(data, options.m, options.type, options));
            this.queue(null);
          };
          input.pipe(through(write, end)).pipe(output);
        }
      }
    },
    processPath: function(filename, options) {
      this.fs.stat(filename, function(err, stat) {
        if (err) {
          throw new Error(err);
        } else if (stat.isDirectory()) {
          this.processDirectory(filename, options);
        } else {
          this.processFile(filename, options);
        }
      }.bind(this));
    },
    processDirectory: function(dirname, options) {
      this.fs.readdir(dirname, function(err, children) {
        if (err) {
          console.error(err.message);
          process.exit(1);
        }
        children.forEach(function(child) {
          this.processPath(path.join(dirname, child), options);
        }.bind(this));
      }.bind(this));
    },
    processFile: function(filename, options) {
      try {
        throw undefined;
      } catch (normalizePath) {
        normalizePath = function(p) {
          return p.replace(/\\/g, '/');
        };
        var ext = path.extname(filename), basenameNoExt = path.basename(filename, ext), dirname = path.dirname(filename), pathNoExt = normalizePath(path.join(dirname, basenameNoExt)), output, outputFilename = normalizePath(path.join(options.to, filename)), moduleName = options['infer-name'] ? pathNoExt: null;
        options = extend({}, options, {m: moduleName});
        this._mkdirp(path.dirname(outputFilename));
        this.processIO(this.fs.createReadStream(filename), this.fs.createWriteStream(outputFilename), options);
      }
    },
    _compile: function(input, moduleName, type, options) {
      var compiler, method;
      type = {
        amd: 'AMD',
        yui: 'YUI',
        cjs: 'CJS',
        globals: 'Globals'
      }[type];
      compiler = new this.Compiler(input, moduleName, options);
      method = "to" + type;
      return compiler[method]();
    },
    _mkdirp: function(directory) {
      var prefix;
      if (this.fs.existsSync(directory)) {
        return;
      }
      prefix = path.dirname(directory);
      if (prefix !== '.' && prefix !== '/') {
        this._mkdirp(prefix);
      }
      return this.fs.mkdirSync(directory);
    }
  }, {});
  return $CLI;
}();
CLI.start = function(Compiler, argv) {
  var stdin = arguments[2] !== (void 0) ? arguments[2]: process.stdin;
  var stdout = arguments[3] !== (void 0) ? arguments[3]: process.stdout;
  var fs_ = arguments[4] !== (void 0) ? arguments[4]: fs;
  return new CLI(Compiler, stdin, stdout, fs_).start(argv);
};
function requireMain() {
  var root = path.join(__dirname, '..'), pkgPath = path.join(root, 'package.json'), pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
  return require(path.join(root, pkg.main));
}
var Compiler = requireMain().Compiler;
CLI.start(Compiler, process.argv);

//@ sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG1wL3RyYW5zcGlsZWQvY29tcGlsZS1tb2R1bGVzLmpzLmVzNiIsInNvdXJjZXMiOlsidG1wL3RyYW5zcGlsZWQvY29tcGlsZS1tb2R1bGVzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQUE7dUJDQUEsU0FBQSxDQUFTLE1BQUEsQ0FBUTtBQUNMLEtBQUEsWUFBQSxFQUFjLEVBQUEsQ0FBQSxDQUFJLEtBQUEsQ0FBTSxNQUFBLEVBQVEsT0FBQSxDQUFBLG1CQUEwQixDQUFDLE1BQUEsQ0FBQTtBQUMvRCxLQUFBLEVBQVMsR0FBQSxFQUFBLEVBQUksRUFBQSxDQUFHLEVBQUEsRUFBSSxNQUFBLENBQUEsTUFBQSxDQUFjLEVBQUEsRUFBQSxDQUFLO0FBQ2pDLE9BQUEsS0FBQSxFQUFPLE1BQUEsQ0FBTSxDQUFBLENBQUE7QUFDakIsZUFBQSxDQUFZLElBQUEsQ0FBQSxFQUFRLE9BQUEsQ0FBQSx3QkFBK0IsQ0FBQyxNQUFBLENBQVEsS0FBQSxDQUFBO0FBQUE7QUFFOUQsUUFBTyxZQUFBO0FBQUEsQ0FBQSwyQkNOZixTQUFBLENBQVMsTUFBQSxDQUFRLGFBQUEsQ0FBYztBQUNyQixLQUFBLEtBQUEsRUFBTyxPQUFBLENBQUEsV0FBQTtBQUNYLFFBQUEsQ0FBQSxjQUFxQixDQUFDLE1BQUEsQ0FBUSxjQUFBLENBQWUsRUFBQyxVQUFBLENBQVksTUFBQSxDQUFBLENBQUE7QUFDMUQsTUFBQSxDQUFBLFNBQUEsRUFBaUIsT0FBQTtBQUNqQixRQUFBLENBQUEsZ0JBQXVCLENBQUMsSUFBQSxDQUFNLGtCQUFpQixDQUFDLFlBQUEsQ0FBQSxDQUFBO0FBQ2hELFFBQU8sS0FBQTtBQUFBLENBQUE7QUZKVCxHQUFBLFNBQUEsRUFBVyxRQUFPLENBQUMsVUFBQSxDQUFBO0FBQ25CLEdBQUEsR0FBQSxFQUFLLFFBQU8sQ0FBQyxJQUFBLENBQUE7QUFDYixHQUFBLEtBQUEsRUFBTyxRQUFPLENBQUMsTUFBQSxDQUFBO0FBQ2YsR0FBQSxRQUFBLEVBQVUsUUFB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QSxJQUFTLENBQUMsSUFBQSxDQUFNLElBQUEsQ0FBQSxJQUFBLENBQUEsQ0FBQTtBQUFBO0dBRzdCLFNBQUEsRUFBVyxZQUFXLENBQUEsQ0FBQSxDQUFBLFFBQUE7QUFFMUIsR0FBQSxDQUFBLEtBQVMsQ0FBQyxRQUFBLENBQVUsUUFBQSxDQUFBLElBQUEsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xudmFyIG9wdGltaXN0ID0gcmVxdWlyZShcIm9wdGltaXN0XCIpO1xudmFyIGZzID0gcmVxdWlyZShcImZzXCIpO1xudmFyIHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcbnZhciB0aHJvdWdoID0gcmVxdWlyZShcInRocm91Z2hcIik7XG5cbmZ1bmN0aW9uIGV4dGVuZCh0YXJnZXQsIC4uLnNvdXJjZXMpIHtcbiAgdmFyIHRvU3RyaW5nID0ge30udG9TdHJpbmc7XG5cbiAgc291cmNlcy5mb3JFYWNoKGZ1bmN0aW9uKHNvdXJjZSkge1xuICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpIHtcbiAgICAgIHRhcmdldFtrZXldID0gc291cmNlW2tleV07XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gdGFyZ2V0O1xufVxuXG5jbGFzcyBDTEkge1xuICBjb25zdHJ1Y3RvcihDb21waWxlciwgc3RkaW49cHJvY2Vzcy5zdGRpbiwgc3Rkb3V0PXByb2Nlc3Muc3Rkb3V0LCBmc189ZnMpIHtcbiAgICB0aGlzLkNvbXBpbGVyID0gQ29tcGlsZXI7XG4gICAgdGhpcy5zdGRpbiA9IHN0ZGluO1xuICAgIHRoaXMuc3Rkb3V0ID0gc3Rkb3V0O1xuICAgIHRoaXMuZnMgPSBmc187XG4gIH1cblxuICBzdGFydChhcmd2KSB7XG4gICAgdmFyIG9wdGlvbnMgPSB0aGlzLnBhcnNlQXJncyhhcmd2KTtcblxuICAgIGlmIChvcHRpb25zLmhlbHApIHtcbiAgICAgIHRoaXMuYXJnUGFyc2VyKGFyZ3YpLnNob3dIZWxwKCk7XG4gICAgfSBlbHNlIGlmIChvcHRpb25zLnN0ZGlvKSB7XG4gICAgICB0aGlzLnByb2Nlc3NTdGRpbyhvcHRpb25zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZm9yICh2YXIgaSA9IDI7IGkgPCBvcHRpb25zLl8ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgdmFyIGZpbGVuYW1lID0gb3B0aW9ucy5fW2ldO1xuICAgICAgICB0aGlzLnByb2Nlc3NQYXRoKGZpbGVuYW1lLCBvcHRpb25zKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwYXJzZUFyZ3MoYXJndikge1xuICAgIHZhciBhcmdzID0gdGhpcy5hcmdQYXJzZXIoYXJndikuYXJndjtcblxuICAgIGlmIChhcmdzLmltcG9ydHMpIHtcbiAgICAgIHZhciBpbXBvcnRzID0ge307XG4gICAgICBhcmdzLmltcG9ydHMuc3BsaXQoJywnKS5mb3JFYWNoKGZ1bmN0aW9uKHBhaXIpIHtcbiAgICAgICAgdmFyIFtyZXF1aXJlUGF0aCwgZ2xvYmFsXSA9IHBhaXIuc3BsaXQoJzonKTtcbiAgICAgICAgaW1wb3J0c1tyZXF1aXJlUGF0aF0gPSBnbG9iYWw7XG4gICAgICB9KTtcbiAgICAgIGFyZ3MuaW1wb3J0cyA9IGltcG9ydHM7XG4gICAgfVxuXG4gICAgaWYgKGFyZ3MuZ2xvYmFsKSB7XG4gICAgICBhcmdzLmludG8gPSBhcmdzLmdsb2JhbDtcbiAgICB9XG5cbiAgICByZXR1cm4gYXJncztcbiAgfVxuXG4gIGFyZ1BhcnNlcihhcmd2KSB7XG4gICAgcmV0dXJuIG9wdGltaXN0KGFyZ3YpLnVzYWdlKCdjb21waWxlLW1vZHVsZXMgdXNhZ2U6XFxuXFxuICBVc2luZyBmaWxlczpcXG4gICAgY29tcGlsZS1tb2R1bGVzIElOUFVUIC0tdG8gRElSIFstLWluZmVyLW5hbWVdIFstLXR5cGUgVFlQRV0gWy0taW1wb3J0cyBQQVRIOkdMT0JBTF1cXG5cXG4gIFVzaW5nIHN0ZGlvOlxcbiAgICBjb21waWxlLW1vZHVsZXMgLS1zdGRpbyBbLS10eXBlIFRZUEVdIFstLWltcG9ydHMgUEFUSDpHTE9CQUxdIFstLW1vZHVsZS1uYW1lIE1PRF0nKS5vcHRpb25zKHtcbiAgICAgIHR5cGU6IHtcbiAgICAgICAgXCJkZWZhdWx0XCI6ICdhbWQnLFxuICAgICAgICBkZXNjcmliZTogJ1RoZSB0eXBlIG9mIG91dHB1dCAob25lIG9mIFwiYW1kXCIsIFwieXVpXCIsIFwiY2pzXCIsIG9yIFwiZ2xvYmFsc1wiKSdcbiAgICAgIH0sXG4gICAgICB0bzoge1xuICAgICAgICBkZXNjcmliZTogJ0EgZGlyZWN0b3J5IGluIHdoaWNoIHRvIHdyaXRlIHRoZSByZXN1bHRpbmcgZmlsZXMnXG4gICAgICB9LFxuICAgICAgaW1wb3J0czoge1xuICAgICAgICBkZXNjcmliZTogJ0EgbGlzdCBvZiBwYXRoOmdsb2JhbCBwYWlycywgY29tbWEgc2VwYXJhdGVkIChlLmcuIGpxdWVyeTokLGVtYmVyOkVtYmVyKSdcbiAgICAgIH0sXG4gICAgICAnaW5mZXItbmFtZSc6IHtcbiAgICAgICAgXCJkZWZhdWx0XCI6IGZhbHNlLFxuICAgICAgICB0eXBlOiAnYm9vbGVhbicsXG4gICAgICAgIGRlc2NyaWJlOiAnQXV0b21hdGljYWxseSBnZW5lcmF0ZSBuYW1lcyBmb3IgQU1EIGFuZCBZVUkgbW9kdWxlcydcbiAgICAgIH0sXG4gICAgICAnbW9kdWxlLW5hbWUnOiB7XG4gICAgICAgIGRlc2NyaWJlOiAnVGhlIG5hbWUgb2YgdGhlIG91dHB1dHRlZCBtb2R1bGUnLFxuICAgICAgICBhbGlhczogJ20nXG4gICAgICB9LFxuICAgICAgc3RkaW86IHtcbiAgICAgICAgXCJkZWZhdWx0XCI6IGZhbHNlLFxuICAgICAgICB0eXBlOiAnYm9vbGVhbicsXG4gICAgICAgIGFsaWFzOiAncycsXG4gICAgICAgIGRlc2NyaWJlOiAnVXNlIHN0ZGluIGFuZCBzdGRvdXQgdG8gcHJvY2VzcyBhIGZpbGUnXG4gICAgICB9LFxuICAgICAgZ2xvYmFsOiB7XG4gICAgICAgIGRlc2NyaWJlOiAnV2hlbiB0aGUgdHlwZSBpcyBgZ2xvYmFsc2AsIHRoZSBuYW1lIG9mIHRoZSBnbG9iYWwgdG8gZXhwb3J0IGludG8nXG4gICAgICB9LFxuICAgICAgaGVscDoge1xuICAgICAgICBcImRlZmF1bHRcIjogZmFsc2UsXG4gICAgICAgIHR5cGU6ICdib29sZWFuJyxcbiAgICAgICAgYWxpYXM6ICdoJyxcbiAgICAgICAgZGVzY3JpYmU6ICdTaG93cyB0aGlzIGhlbHAgbWVzc2FnZSdcbiAgICAgIH1cbiAgICB9KS5jaGVjaygoe3R5cGV9KSA9PiB0eXBlID09PSAnYW1kJyB8fCB0eXBlID09PSAneXVpJyB8fCB0eXBlID09PSAnY2pzJyB8fCB0eXBlID09PSAnZ2xvYmFscycpXG4gICAgLmNoZWNrKGFyZ3MgPT4gIWFyZ3NbJ2luZmVyLW5hbWUnXSB8fCAhYXJncy5tKVxuICAgIC5jaGVjayhhcmdzID0+IChhcmdzLnN0ZGlvICYmIGFyZ3MudHlwZSA9PT0gJ2FtZCcpID8gIWFyZ3NbJ2luZmVyLW5hbWUnXSA6IHRydWUpXG4gICAgLmNoZWNrKGFyZ3MgPT4gKGFyZ3Muc3RkaW8gJiYgYXJncy50eXBlID09PSAneXVpJykgPyAhYXJnc1snaW5mZXItbmFtZSddIDogdHJ1ZSlcbiAgICAuY2hlY2soYXJncyA9PiBhcmdzLnN0ZGlvIHx8IGFyZ3MudG8gfHwgYXJncy5oZWxwKVxuICAgIC5jaGVjayhhcmdzID0+IGFyZ3MuaW1wb3J0cyA/IGFyZ3MudHlwZSA9PT0gJ2dsb2JhbHMnIDogYXJncy50eXBlICE9PSAnZ2xvYmFscycpO1xuICB9XG5cbiAgcHJvY2Vzc1N0ZGlvKG9wdGlvbnMpIHtcbiAgICB0aGlzLnByb2Nlc3NJTyh0aGlzLnN0ZGluLCB0aGlzLnN0ZG91dCwgb3B0aW9ucyk7XG4gIH1cblxuICBwcm9jZXNzSU8oaW5wdXQsIG91dHB1dCwgb3B0aW9ucykge1xuICAgIHZhciBkYXRhID0gJycsXG4gICAgICAgIHNlbGYgPSB0aGlzO1xuXG4gICAgZnVuY3Rpb24gd3JpdGUoY2h1bmspIHtcbiAgICAgIGRhdGEgKz0gY2h1bms7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZW5kKCkge1xuICAgICAgLyoganNoaW50IC1XMDQwICovXG4gICAgICB0aGlzLnF1ZXVlKHNlbGYuX2NvbXBpbGUoZGF0YSwgb3B0aW9ucy5tLCBvcHRpb25zLnR5cGUsIG9wdGlvbnMpKTtcbiAgICAgIHRoaXMucXVldWUobnVsbCk7XG4gICAgfVxuXG4gICAgaW5wdXQucGlwZSh0aHJvdWdoKHdyaXRlLCBlbmQpKS5waXBlKG91dHB1dCk7XG4gIH1cblxuICBwcm9jZXNzUGF0aChmaWxlbmFtZSwgb3B0aW9ucykge1xuICAgIHRoaXMuZnMuc3RhdChmaWxlbmFtZSwgZnVuY3Rpb24oZXJyLCBzdGF0KSB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihlcnIpO1xuICAgICAgfSBlbHNlIGlmIChzdGF0LmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgdGhpcy5wcm9jZXNzRGlyZWN0b3J5KGZpbGVuYW1lLCBvcHRpb25zKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMucHJvY2Vzc0ZpbGUoZmlsZW5hbWUsIG9wdGlvbnMpO1xuICAgICAgfVxuICAgIH0uYmluZCh0aGlzKSk7XG4gIH1cblxuICBwcm9jZXNzRGlyZWN0b3J5KGRpcm5hbWUsIG9wdGlvbnMpIHtcbiAgICB0aGlzLmZzLnJlYWRkaXIoZGlybmFtZSwgZnVuY3Rpb24oZXJyLCBjaGlsZHJlbikge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVyci5tZXNzYWdlKTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgfVxuICAgICAgY2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihjaGlsZCkge1xuICAgICAgICB0aGlzLnByb2Nlc3NQYXRoKHBhdGguam9pbihkaXJuYW1lLCBjaGlsZCksIG9wdGlvbnMpO1xuICAgICAgfS5iaW5kKHRoaXMpKTtcbiAgICB9LmJpbmQodGhpcykpO1xuICB9XG5cbiAgcHJvY2Vzc0ZpbGUoZmlsZW5hbWUsIG9wdGlvbnMpIHtcbiAgICBmdW5jdGlvbiBub3JtYWxpemVQYXRoKHApIHtcbiAgICAgIHJldHVybiBwLnJlcGxhY2UoL1xcXFwvZywgJy8nKTtcbiAgICB9XG5cbiAgICB2YXIgZXh0ICAgICAgICAgICAgPSBwYXRoLmV4dG5hbWUoZmlsZW5hbWUpLFxuICAgICAgICBiYXNlbmFtZU5vRXh0ICA9IHBhdGguYmFzZW5hbWUoZmlsZW5hbWUsIGV4dCksXG4gICAgICAgIGRpcm5hbWUgICAgICAgID0gcGF0aC5kaXJuYW1lKGZpbGVuYW1lKSxcbiAgICAgICAgcGF0aE5vRXh0ICAgICAgPSBub3JtYWxpemVQYXRoKHBhdGguam9pbihkaXJuYW1lLCBiYXNlbmFtZU5vRXh0KSksXG4gICAgICAgIG91dHB1dCxcbiAgICAgICAgb3V0cHV0RmlsZW5hbWUgPSBub3JtYWxpemVQYXRoKHBhdGguam9pbihvcHRpb25zLnRvLCBmaWxlbmFtZSkpLFxuICAgICAgICBtb2R1bGVOYW1lICAgICA9IG9wdGlvbnNbJ2luZmVyLW5hbWUnXSA/IHBhdGhOb0V4dCA6IG51bGw7XG5cbiAgICBvcHRpb25zID0gZXh0ZW5kKHt9LCBvcHRpb25zLCB7bTogbW9kdWxlTmFtZX0pO1xuICAgIHRoaXMuX21rZGlycChwYXRoLmRpcm5hbWUob3V0cHV0RmlsZW5hbWUpKTtcblxuICAgIHRoaXMucHJvY2Vzc0lPKFxuICAgICAgdGhpcy5mcy5jcmVhdGVSZWFkU3RyZWFtKGZpbGVuYW1lKSxcbiAgICAgIHRoaXMuZnMuY3JlYXRlV3JpdGVTdHJlYW0ob3V0cHV0RmlsZW5hbWUpLFxuICAgICAgb3B0aW9uc1xuICAgICk7XG4gIH1cblxuICBfY29tcGlsZShpbnB1dCwgbW9kdWxlTmFtZSwgdHlwZSwgb3B0aW9ucykge1xuICAgIHZhciBjb21waWxlciwgbWV0aG9kO1xuICAgIHR5cGUgPSB7XG4gICAgICBhbWQ6ICdBTUQnLFxuICAgICAgeXVpOiAnWVVJJyxcbiAgICAgIGNqczogJ0NKUycsXG4gICAgICBnbG9iYWxzOiAnR2xvYmFscydcbiAgICB9W3R5cGVdO1xuICAgIGNvbXBpbGVyID0gbmV3IHRoaXMuQ29tcGlsZXIoaW5wdXQsIG1vZHVsZU5hbWUsIG9wdGlvbnMpO1xuICAgIG1ldGhvZCA9IFwidG9cIiArIHR5cGU7XG4gICAgcmV0dXJuIGNvbXBpbGVyW21ldGhvZF0oKTtcbiAgfVxuXG4gIF9ta2RpcnAoZGlyZWN0b3J5KSB7XG4gICAgdmFyIHByZWZpeDtcbiAgICBpZiAodGhpcy5mcy5leGlzdHNTeW5jKGRpcmVjdG9yeSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgcHJlZml4ID0gcGF0aC5kaXJuYW1lKGRpcmVjdG9yeSk7XG4gICAgaWYgKHByZWZpeCAhPT0gJy4nICYmIHByZWZpeCAhPT0gJy8nKSB7XG4gICAgICB0aGlzLl9ta2RpcnAocHJlZml4KTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZnMubWtkaXJTeW5jKGRpcmVjdG9yeSk7XG4gIH1cbn1cblxuQ0xJLnN0YXJ0ID0gZnVuY3Rpb24oQ29tcGlsZXIsIGFyZ3YsIHN0ZGluPXByb2Nlc3Muc3RkaW4sIHN0ZG91dD1wcm9jZXNzLnN0ZG91dCwgZnNfPWZzKSB7XG4gIHJldHVybiBuZXcgQ0xJKENvbXBpbGVyLCBzdGRpbiwgc3Rkb3V0LCBmc18pLnN0YXJ0KGFyZ3YpO1xufTtcblxuZnVuY3Rpb24gcmVxdWlyZU1haW4oKSB7XG4gIHZhciByb290ICAgID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJyksXG4gICAgICBwa2dQYXRoID0gcGF0aC5qb2luKHJvb3QsICdwYWNrYWdlLmpzb24nKSxcbiAgICAgIHBrZyAgICAgPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhwa2dQYXRoLCAndXRmOCcpKTtcblxuICByZXR1cm4gcmVxdWlyZShwYXRoLmpvaW4ocm9vdCwgcGtnLm1haW4pKTtcbn1cblxubGV0IENvbXBpbGVyID0gcmVxdWlyZU1haW4oKS5Db21waWxlcjtcblxuQ0xJLnN0YXJ0KENvbXBpbGVyLCBwcm9jZXNzLmFyZ3YpO1xuIl19